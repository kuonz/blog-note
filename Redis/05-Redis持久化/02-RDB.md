---
author: "kuonz"
draft: false
title: "RDB"
date: 2020-04-05
categories: ["Redis持久化"]
---
  
## RDB是什么

RDB：Redis DataBase

备份：将内存中的数据保存在磁盘中的一个文件中

恢复：根据磁盘中的文件，将数据写入内存中



## RDB三种触发方式

### save命令触发[同步]

使用：`redis-cli> save`

原理：在原线程上创建RDB文件

特点：阻塞

运行图：

```
             save                  create 
client ---------------> redis ---------------> RDB
```

### bgsave命令触发[异步]

使用：`redis-cli> bgsave`

原理：先fork出子进程，然后在该子进程中进行数据的持久化

特点：fork进程的过程是阻塞的；子进程创建RDB是非阻塞的

运行图：

```
           1.bgsave                            正常服务
client  -------------------------> redis ---------------------> clients
              |                      ^  
              |                      |
          2.fork()                   | 4.bgsave successfully
              |                      | 
              v        3.create      |
         redis子进程 ------------> RDB文件
```

### 配置触发[异步]

使用：根据配置文件自动调用bgsave

原理：与bgsave方式相同

运行图：与bgsave方式相同

配置：

| 项目                        | 可选值           | 说明                                                         |
| --------------------------- | ---------------- | ------------------------------------------------------------ |
| save                        | [second] [times] | 如果 second 秒内有 times 条数据更新，则进行bgsave            |
| dbfilename                  | [filename]       | 设置本地数据库文件名，默认值为 dump.rdb<br />通常设置为 dump-端口号.rdb |
| rdbcompression              | [yes\|no]        | 是否启用数据压缩，默认为yes，采用LZF压缩                     |
| rdbchecksum                 | [yes\|no]        | 设置是否进行RDB文件格式校验，该校验过程在写文件和读文件过程均进行，通常默认为开启状态，如果设置为no，可以节约读写性过程约10%时间消耗，但是存储一定的数据损坏风险 |
| stop-writes-on-bgsave-error | [yes\|no]        | 是否在出错时停止，默认 yes                                   |

示例

```shell
save 900 1     #900秒时间，至少有一条数据更新，则保存到数据文件中
save 300 10    #300秒时间，至少有10条数据更新，则保存到数据文件中
save 60 10000  #60秒时间，至少有10000条数据更新，则保存到数据文件中
dbfilename dump-6380.rdb # rdb导出文件为 dump-6380.rdb
rdbcompression yes # 开启数据压缩
rdbchecksum yes # 开启数据校验
stop-writes-on-bgsave-error yes # 在出错时停止
```

### save和bgsave/配置触发对比

| 对比项         | save             | bgsave/配置触发      |
| -------------- | ---------------- | -------------------- |
| IO类型         | 同步             | 异步                 |
| 是否阻塞       | 是               | 是(阻塞发生在fork上) |
| 复杂度         | O(n)             | O(n)                 |
| 是否启动新进程 | 否               | 是                   |
| 优点           | 不会消耗额外内存 | 不阻塞客户端命令     |
| 缺点           | 阻塞客户端命令   | 需要fork，消耗内存   |

### RDB三种自动触发时机

| 时机          | 说明                                               |
| ------------- | -------------------------------------------------- |
| 全量复制      | 使用主从复制时需要拷贝数据，则需要RDB导出快照文件  |
| debug reload  | 运行时重启                                         |
| shutdown save | 关闭时保存，默认情况下执行shutdown命令时，自动执行 |





## RDB优缺点

### 优点

1. RDB是一个紧凑压缩的二进制文件，存储效率较高
2. RDB内部存储的是redis在某个时间点的数据快照，非常适合用于数据备份，全量复制等场景
3. RDB恢复数据的速度要比AOF快很多
4. 应用：服务器中每X小时执行bgsave备份，并将RDB文件拷贝到远程机器中，用于灾难恢复

### 缺点

1. RDB方式无论是执行指令还是利用配置，无法做到实时持久化，具有较大的可能性丢失数据
2. bgsave指令每次运行要执行fork操作创建子进程，要牺牲掉一些性能
3. Redis的众多版本中未进行RDB文件格式的版本统一，有可能出现各版本服务之间数据格式无法兼容现象

